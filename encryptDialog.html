<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; padding: 24px; line-height: 1.5; background: #fafbfc; }
      .container { max-width: 480px; background: white; padding: 32px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
      label { display: block; margin: 20px 0 8px; font-weight: 600; color: #333; font-size: 14px; }
      input, textarea { width: 100%; padding: 12px 16px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px; box-sizing: border-box; font-family: inherit; transition: all 0.2s; }
      input:focus, textarea:focus { outline: none; border-color: #4285f4; box-shadow: 0 0 0 3px rgba(66,133,244,0.1); }
      textarea { height: 100px; resize: vertical; }
      .input-row { position: relative; }
      .duplicate-warning { 
        display: flex; align-items: center; gap: 8px; 
        padding: 8px 12px; background: #fef7e0; border: 1px solid #f9ab00; 
        border-radius: 8px; margin-top: 4px; font-size: 14px; color: #d97706;
      }
      .duplicate-warning strong { color: #b45309; }
      .warning-icon { width: 16px; height: 16px; }
      button { background: #4285f4; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 500; transition: background 0.2s; margin: 8px 8px 0 0; }
      button:hover:not(:disabled) { background: #3367d6; }
      button:disabled { background: #ccc; cursor: not-allowed; }
      .status { margin: 16px 0; padding: 12px 16px; border-radius: 8px; font-size: 14px; }
      .success { background: #e8f5e8; color: #155724; border: 1px solid #c3e6c3; }
      .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
      .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
      #progress { display: none; }
      #strengthMeter { display: none; margin: 8px 0 16px 0; }
      #strengthBar { height: 6px; border-radius: 3px; transition: all 0.3s ease; width: 0%; }
      .invalid { border-color: #ea4335 !important; box-shadow: 0 0 0 3px rgba(234,67,53,0.1) !important; }
      #strengthLabel { color: #5f6368; font-weight: 500; }
    </style>
  </head>
  <body>
    <div class="container">
      <h2 style="margin: 0 0 32px 0; color: #202124; font-weight: 400;">Add New Secret Entry</h2>

      <label for="label">Label</label>
      <div class="input-row">
        <input type="text" id="label" placeholder="API Key, Database Password, etc." required>
        <div id="duplicateWarning" class="duplicate-warning" style="display: none;">
          <svg class="warning-icon" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          </svg>
          <span><strong>Duplicate label detected:</strong> "<span id="duplicateLabel"></span>" already exists (row <span id="duplicateRow"></span>)</span>
        </div>
      </div>

      <label for="secret">Secret</label>
      <textarea id="secret" placeholder="Paste your secret here..." required></textarea>

      <label for="password">Password <span id="strengthLabel"></span></label>
      <input type="password" id="password" placeholder="Strong password recommended" required>
      <div id="strengthMeter">
        <div style="width: 100%; height: 6px; border-radius: 3px; background: #e8eaed; overflow: hidden;">
          <div id="strengthBar"></div>
        </div>
        <small id="strengthText" style="color: #5f6368; font-size: 13px;"></small>
      </div>

      <label for="confirmPassword">Confirm Password</label>
      <input type="password" id="confirmPassword" placeholder="Repeat password" required>

      <div>
        <button id="encryptBtn" onclick="addEntry()">âž• Add Entry</button>
        <button onclick="google.script.host.close()" style="background: #f1f3f4; color: #3c4043;">Cancel</button>
      </div>

      <div id="progress">
        <div class="status info">ðŸ”„ Encrypting with AES-256 (200k iterations)...</div>
      </div>
      <div id="status"></div>
    </div>

    <script>
      const SALT_BYTES = 16;
      const IV_BYTES = 12;
      const PBKDF2_ITERATIONS = 200000;
      const VERSION = 1;
      let duplicateCheckTimeout;

      const labelInput = document.getElementById('label');
      const secretInput = document.getElementById('secret');
      const passwordInput = document.getElementById('password');
      const confirmPasswordInput = document.getElementById('confirmPassword');
      const encryptBtn = document.getElementById('encryptBtn');
      const progress = document.getElementById('progress');
      const status = document.getElementById('status');
      const strengthMeter = document.getElementById('strengthMeter');
      const strengthBar = document.getElementById('strengthBar');
      const strengthText = document.getElementById('strengthText');
      const strengthLabel = document.getElementById('strengthLabel');
      const duplicateWarning = document.getElementById('duplicateWarning');
      const duplicateLabel = document.getElementById('duplicateLabel');
      const duplicateRow = document.getElementById('duplicateRow');

      // Auto-focus
      labelInput.focus();

      labelInput.addEventListener('input', () => {
        clearTimeout(duplicateCheckTimeout);
        duplicateCheckTimeout = setTimeout(checkForDuplicate, 250); // (250ms debounce)
      });

      async function checkForDuplicate() {
        const label = labelInput.value.trim();
        if (!label) {
          hideDuplicateWarning();
          return;
        }

        try {
          const result = await google.script.run.withSuccessHandler(handleDuplicateCheck).withFailureHandler(() => hideDuplicateWarning()).checkDuplicateLabel(label);
        } catch (e) {
          hideDuplicateWarning();
        }
      }

      function handleDuplicateCheck(result) {
        if (result.exists) {
          duplicateLabel.textContent = result.label;
          duplicateRow.textContent = result.row;
          duplicateWarning.style.display = 'flex';
          labelInput.classList.add('invalid');
        } else {
          hideDuplicateWarning();
        }
      }

      function hideDuplicateWarning() {
        duplicateWarning.style.display = 'none';
        labelInput.classList.remove('invalid');
      }

      function calculateStrength(password) {
        let score = 0;
        if (password.length >= 8) score += 1;
        if (password.length >= 12) score += 1;
        if (/[a-z]/.test(password)) score += 0.5;
        if (/[A-Z]/.test(password)) score += 0.5;
        if (/[0-9]/.test(password)) score += 0.5;
        if (/[^a-zA-Z0-9]/.test(password)) score += 0.5;
        return Math.floor(Math.min(3, score));
      }

      function updateStrengthMeter(password) {
        if (!password) {
          strengthMeter.style.display = 'none';
          strengthLabel.textContent = '';
          return;
        }
        const strength = calculateStrength(password);
        strengthMeter.style.display = 'block';
        const colors = ['#ea4335', '#fb8b24', '#fbbc04', '#34a853'];
        strengthBar.style.background = colors[strength];
        strengthBar.style.width = `${(strength + 1) * 25}%`;
        const labels = ['Weak', 'Fair', 'Good', 'Strong'];
        strengthText.textContent = `${labels[strength]} (${password.length} chars)`;
        const tips = ['Add length & variety', 'Good start', 'Almost there', 'Perfect!'];
        strengthLabel.textContent = `â€” ${tips[strength]}`;
      }

      passwordInput.addEventListener('input', () => updateStrengthMeter(passwordInput.value));
      confirmPasswordInput.addEventListener('input', () => {
        confirmPasswordInput.classList.toggle('invalid', confirmPasswordInput.value && passwordInput.value !== confirmPasswordInput.value);
      });

      async function addEntry() {
        const entryLabel = labelInput.value.trim();
        const secret = secretInput.value.trim();
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (!entryLabel) { showStatus('Enter a label.', 'error'); labelInput.focus(); return; }
        if (duplicateWarning.style.display === 'flex') { showStatus('Duplicate label detected. Change label or use existing entry.', 'error'); labelInput.focus(); return; }
        if (!secret) { showStatus('Enter a secret.', 'error'); secretInput.focus(); return; }
        const strength = calculateStrength(password);
        if (strength < 2) { showStatus('Password too weak. Use 12+ chars with letters, numbers, symbols.', 'error'); passwordInput.focus(); return; }
        if (password !== confirmPassword) { showStatus('Passwords do not match.', 'error'); confirmPasswordInput.focus(); return; }

        encryptBtn.disabled = true;
        encryptBtn.textContent = 'ðŸ”„ Adding...';
        progress.style.display = 'block';
        status.innerHTML = '';

        try {
          const salt = await generateRandomBytes(SALT_BYTES);
          const iv = await generateRandomBytes(IV_BYTES);
          const key = await deriveKey(password, salt);
          const encrypted = await encryptAESGCM(secret, key, iv);

          const payload = { v: VERSION, salt: arrayBufferToBase64(salt), iv: arrayBufferToBase64(iv), ct: arrayBufferToBase64(encrypted) };
          const encryptedJson = JSON.stringify(payload);

          await google.script.run.withSuccessHandler(onSaveSuccess).withFailureHandler(onSaveError).addNewEntry(entryLabel, encryptedJson);
        } catch (error) {
          showStatus(`Encryption failed: ${error.message}`, 'error');
          encryptBtn.disabled = false;
          encryptBtn.textContent = 'âž• Add Entry';
          progress.style.display = 'none';
        }
      }

      async function generateRandomBytes(length) {
        const bytes = new Uint8Array(length);
        window.crypto.getRandomValues(bytes);
        return bytes.buffer;
      }

      async function deriveKey(password, salt) {
        const encoder = new TextEncoder();
        const keyMaterial = await window.crypto.subtle.importKey('raw', encoder.encode(password), { name: 'PBKDF2' }, false, ['deriveKey']);
        return window.crypto.subtle.deriveKey({ name: 'PBKDF2', salt, iterations: PBKDF2_ITERATIONS, hash: 'SHA-256' }, keyMaterial, { name: 'AES-GCM', length: 256 }, false, ['encrypt']);
      }

      async function encryptAESGCM(plaintext, key, iv) {
        const encoder = new TextEncoder();
        return await window.crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, encoder.encode(plaintext));
      }

      function arrayBufferToBase64(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
        return btoa(binary);
      }

      function showStatus(message, type) {
        status.innerHTML = `<div class="status ${type}">${message}</div>`;
      }

      function onSaveSuccess() {
        showStatus('âœ… New entry added successfully!', 'success');
        setTimeout(() => { 
          labelInput.value = ''; secretInput.value = ''; passwordInput.value = ''; confirmPasswordInput.value = ''; 
          google.script.host.close(); 
        }, 1500);
      }

      function onSaveError(error) {
        showStatus(`Save failed: ${error.message}`, 'error');
        encryptBtn.disabled = false;
        encryptBtn.textContent = 'âž• Add Entry';
        progress.style.display = 'none';
      }

      window.addEventListener('beforeunload', () => {
        labelInput.value = ''; secretInput.value = ''; passwordInput.value = ''; confirmPasswordInput.value = '';
      });
    </script>
  </body>
</html>
