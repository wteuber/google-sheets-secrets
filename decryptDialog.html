<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; padding: 24px; line-height: 1.5; background: #fafbfc; }
      .container { max-width: 480px; background: white; padding: 32px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
      label { display: block; margin: 20px 0 8px; font-weight: 600; color: #333; font-size: 14px; }
      input, textarea { width: 100%; padding: 12px 16px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px; box-sizing: border-box; font-family: inherit; transition: border-color 0.2s; }
      input:focus, textarea:focus { outline: none; border-color: #4285f4; box-shadow: 0 0 0 3px rgba(66,133,244,0.1); }
      textarea { height: 140px; resize: vertical; font-family: 'SF Mono', Menlo, Monaco, monospace; background: #f8f9fa; }
      textarea:focus { background: white; }
      button { background: #4285f4; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 500; transition: background 0.2s; margin: 8px 8px 0 0; }
      button:hover:not(:disabled) { background: #3367d6; }
      button:disabled { background: #ccc; cursor: not-allowed; }
      .status { margin: 16px 0; padding: 12px 16px; border-radius: 8px; font-size: 14px; }
      .success { background: #e8f5e8; color: #155724; border: 1px solid #c3e6c3; }
      .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
      .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
      #progress { display: none; }
      #rowInfo { background: #f0f7ff; padding: 12px 16px; border-radius: 8px; margin-bottom: 24px; font-size: 14px; color: #1a73e8; border: 1px solid #c6dfff; }
      #copyBtn { background: #34a853; }
      #copyBtn:hover:not(:disabled) { background: #2d862d; }
      .debug { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; padding: 12px; border-radius: 8px; margin: 16px 0; font-family: monospace; font-size: 12px; display: none; }
    </style>
  </head>
  <body>
    <div class="container">
      <h2 style="margin: 0 0 32px 0; color: #202124; font-weight: 400;">Decrypt Secret</h2>

      <div id="rowInfo">
        <strong>Row <span id="rowSpan"></span>:</strong> <span id="labelSpan"></span>
      </div>

      <label for="password">Password</label>
      <input type="password" id="password" placeholder="Enter password to decrypt">

      <div>
        <button id="decryptBtn" onclick="decryptSecret()">ðŸ”“ Decrypt</button>
        <button id="copyBtn" onclick="copySecret()" style="display: none; background: #34a853;">ðŸ“‹ Copy</button>
        <button onclick="google.script.host.close()" style="background: #f1f3f4; color: #3c4043;">Close</button>
      </div>

      <div id="progress">
        <div class="status info">ðŸ”„ Decrypting with AES-256 (200k iterations)...</div>
      </div>

      <div id="status"></div>

      <label for="decryptedSecret" id="decryptedLabel" style="display: none;">Decrypted Secret</label>
      <textarea id="decryptedSecret" readonly placeholder="Decrypted secret will appear here..." style="display: none;"></textarea>

      <!-- Debug info (hidden by default) -->
      <div id="debugInfo" class="debug">
        <strong>Debug (click row to toggle):</strong><br>
        <span id="debugContent"></span>
      </div>
    </div>

    <script>
      const rowIndex = Number(<?= JSON.stringify(rowIndex) ?>);
      const label = <?= JSON.stringify(label) ?> || '(no label)';
      const encryptedJsonRaw = <?= JSON.stringify(encryptedJson) ?> || '';

      let payload;
      try {
        let jsonStr = encryptedJsonRaw;
        if (typeof jsonStr === 'string' && jsonStr.startsWith('"') && jsonStr.endsWith('"')) {
          jsonStr = JSON.parse(jsonStr);
        }
        payload = typeof jsonStr === 'string' ? JSON.parse(jsonStr) : jsonStr;
      } catch (e) {
        payload = null;
      }

      const rowSpanEl = document.getElementById('rowSpan');
      const labelSpanEl = document.getElementById('labelSpan');
      const passwordInput = document.getElementById('password');
      const decryptBtn = document.getElementById('decryptBtn');
      const copyBtn = document.getElementById('copyBtn');
      const progress = document.getElementById('progress');
      const status = document.getElementById('status');
      const decryptedSecret = document.getElementById('decryptedSecret');
      const decryptedLabel = document.getElementById('decryptedLabel');
      const debugInfo = document.getElementById('debugInfo');
      const debugContent = document.getElementById('debugContent');

      rowSpanEl.textContent = rowIndex;
      labelSpanEl.textContent = label;

      // Auto-focus password
      passwordInput.focus();

      // Debug toggle (click row info)
      document.getElementById('rowInfo').addEventListener('click', () => {
        debugInfo.style.display = debugInfo.style.display === 'block' ? 'none' : 'block';
        if (payload && debugInfo.style.display === 'block') {
          debugContent.textContent = `v${payload.v} | salt:${payload.salt?.substring(0,8)}... | iv:${payload.iv?.substring(0,8)}... | ct:${payload.ct?.substring(0,12)}...`;
        }
      });

      const PBKDF2_ITERATIONS = 200000;

      async function decryptSecret() {
        const password = passwordInput.value;
        if (!password) { 
          showStatus('Enter password.', 'error'); 
          passwordInput.focus(); 
          return; 
        }

        if (!payload || !payload.salt || !payload.iv || !payload.ct) {
          showStatus('No valid encrypted data found.', 'error');
          return;
        }

        decryptBtn.disabled = true;
        decryptBtn.textContent = 'ðŸ”„ Decrypting...';
        progress.style.display = 'block';
        status.innerHTML = '';

        try {
          const salt = base64ToArrayBuffer(payload.salt);
          const iv = base64ToArrayBuffer(payload.iv);
          const ct = base64ToArrayBuffer(payload.ct);

          const key = await deriveKey(password, salt);
          const decrypted = await decryptAESGCM(ct, key, iv);

          const decoder = new TextDecoder();
          decryptedSecret.value = decoder.decode(decrypted);
          decryptedSecret.style.display = 'block';
          decryptedLabel.style.display = 'block';
          decryptedSecret.focus();
          decryptedSecret.select();
          
          copyBtn.style.display = 'inline-block';
          showStatus('âœ… Decrypted successfully! Use Copy or Ctrl+C', 'success');

        } catch (error) {
          let msg = 'Decryption failed';
          if (error.message.includes('OperationError') || error.message.includes('Authentication')) {
            msg += ': Wrong password';
          } else if (error.message.includes('atob')) {
            msg += ': Data corrupted';
          } else {
            msg += `: ${error.message}`;
          }
          showStatus(msg, 'error');
        } finally {
          decryptBtn.disabled = false;
          decryptBtn.textContent = 'ðŸ”“ Decrypt';
          progress.style.display = 'none';
        }
      }

      async function copySecret() {
        try {
          await navigator.clipboard.writeText(decryptedSecret.value);
          showStatus('âœ… Copied to clipboard!', 'success');
        } catch {
          decryptedSecret.select();
          document.execCommand('copy');
          showStatus('âœ… Copied (fallback)', 'success');
        }
      }

      async function deriveKey(password, salt) {
        const encoder = new TextEncoder();
        const keyMaterial = await window.crypto.subtle.importKey(
          'raw', encoder.encode(password), { name: 'PBKDF2' }, false, ['deriveKey']
        );
        return window.crypto.subtle.deriveKey(
          { name: 'PBKDF2', salt, iterations: PBKDF2_ITERATIONS, hash: 'SHA-256' },
          keyMaterial, { name: 'AES-GCM', length: 256 }, false, ['decrypt']
        );
      }

      async function decryptAESGCM(ct, key, iv) {
        return window.crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ct);
      }

      function base64ToArrayBuffer(b64) {
        if (!b64) throw new Error('Empty Base64');
        let fixedB64 = b64.replace(/-/g, '+').replace(/_/g, '/');
        const padding = 4 - (fixedB64.length % 4);
        if (padding !== 4) fixedB64 += '='.repeat(padding);
        const binaryString = atob(fixedB64);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
      }

      function showStatus(message, type) {
        status.innerHTML = `<div class="status ${type}">${message}</div>`;
      }

      window.addEventListener('beforeunload', () => {
        decryptedSecret.value = '';
        passwordInput.value = '';
      });
    </script>
  </body>
</html>
